#' Create an ECharts widget
#'
#' Create an HTML widget for ECharts that can be rendered in the R console, R
#' Markdown documents, or Shiny apps. You can add more components to this widget
#' and customize options later. \code{eChart()} is an alias of \code{echart()}.
#' @param data a data object (usually a data frame or a list)
#' @rdname eChart
#' @export
#' @examples library(recharts)
#' ### scatter plot
#' echart(iris, ~ Sepal.Length, ~ Sepal.Width)
#' echart(iris, ~ Sepal.Length, ~ Sepal.Width, series = ~ Species)
#'
#' # bar chart
#' bar_df = data.frame(
#'    date = rep(paste("day",1:10), 2),
#'    temperature = floor(rnorm(n = 20, mean = 20, sd = 10)),
#'    location = rep(c("NY","DC"), each = 10)
#'   )
#' echart(bar_df, ~date, ~temperature, ~location)
#'
#' #line chart
#' echart(bar_df, ~date, ~temperature, ~location, type="line")
echart = function(data, ...) {
  UseMethod('echart')
}

#' @export
#' @rdname eChart
echart.list = function(data, width = NULL, height = NULL, ...) {
  htmlwidgets::createWidget(
    'echarts', data, width = width, height = height, package = 'recharts'
  )
}

#' @param x the x variable
#' @param y the y variable
#' @export
#' @rdname eChart
echart.data.frame = function(
  data = NULL, x = NULL, y = NULL, series = NULL, type = 'auto',
  width = NULL, height = NULL, ...
) {

  xlab = autoArgLabel(x, deparse(substitute(x)))
  ylab = autoArgLabel(y, deparse(substitute(y)))

  x = evalFormula(x, data)
  y = evalFormula(y, data)
  if (type == 'auto') type = determineType(x, y)

  # for bar plot, convert x  to factors
  if (type == 'bar' && !is.factor(x)) x = as.factor(x)
  if (type == 'bar' && !is.numeric(y)) stop("y must be numeric for bar plot.")

  series = evalFormula(series, data)
  data_fun = getFromNamespace(paste0('data_', type), 'recharts')

  # start axis from 0?
  if (is.numeric(x)) min_xaxis = ifelse( min(x) >0, 0, min(x))
  if (is.numeric(y)) min_yaxis = ifelse( min(y) >0, 0, min(y))

  # run before generating the list
  data_prepared = data_fun(x, y, series)

  params = structure(list(
    series = data_prepared$series_data,
    xAxis = list(), yAxis = list()
    ), meta = list(
    x = x, y = y
  ))
  if (!is.null(series)) params$legend = list(data = unique(series))

  chart = htmlwidgets::createWidget(
    'echarts', params, width = width, height = height, package = 'recharts',
    dependencies = getDependency(NULL)
  )
  ###start both axes from 0.
  ###but why would you ever want to start a scatter plot from 0? so turn it back.


  if (type == "scatter") return (chart %>% eAxis('x', name = xlab) %>% eAxis('y', name = ylab))
  if (type == "bar") return (chart %>% eAxis('x', name = xlab, data = data_prepared$xaxis) %>% eAxis('y', name = ylab, min = min_yaxis))
  if (type == "line") return (chart %>% eAxis('x', name = xlab, data = data_prepared$xaxis) %>% eAxis('y', name = ylab, min = min_yaxis))
  if (type == "histogram") return (chart %>%
                                     eAxis('x', name = xlab, type="value") %>%
                                     eAxis('y', name = 'Count', min = 0, type='value'))


}

#' @export
#' @rdname eChart
echart.default = echart.data.frame

#' @export
#' @rdname eChart
eChart = echart
# from the planet of "Duo1 Qiao1 Yi1 Ge4 Jian4 Hui4 Si3" (will die if having to
# press one more key, i.e. Shift in this case)

determineType = function(x, y) {
  if (is.numeric(x) && is.numeric(y)) return('scatter')
  if (is.factor(x) && is.numeric(y)) return("bar")
  if (is.numeric(x) && is.null(y)) return("histogram")
  message('The structure of x:')
  str(x)
  message('The structure of y:')
  str(y)
  stop('Unable to determine the chart type from x and y automatically')
}

# not usable yet; see https://github.com/ecomfe/echarts/issues/1065
getDependency = function(type) {
  if (is.null(type)) return()
  htmltools::htmlDependency(
    'echarts-module', EChartsVersion,
    src = system.file('htmlwidgets/lib/echarts/chart', package = 'recharts'),
    script = sprintf('%s.js', type)
  )
}

getMeta = function(chart) {
  attr(chart$x, 'meta', exact = TRUE)
}
